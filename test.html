<!DOCTYPE html>
<html>
<head>
<title>MIDI test</title>
<script src="https://cdn.jsdelivr.net/npm/jzz"></script>
<script src="https://cdn.jsdelivr.net/npm/jzz-synth-tiny"></script>
</head>

<body>
<h1>MIDI test</h1>

<p>
MIDI Out: <select id=selectmidiout></select>
</p><p>
Send MIDI (e.g. <tt>90 40 7f</tt>):
<input id=textinput></input>
<span id=reportspan></span>
</p>
<pre id=textoutput></pre>

<script><!--
var selectMidiOut = document.getElementById('selectmidiout');
var textInput = document.getElementById('textinput');
var textOutput = document.getElementById('textoutput');
var reportSpan = document.getElementById('reportspan');
var midiOutName = 'Not available';
var midiOutPort;
var output = [];
var previous = ['90 40 7f'];
var ptr = -1;

function setListbox(lb, s) {
  for (var i = 0; i < lb.options.length; i++) if (lb.options[i].value == s) lb.options[i].selected = 1;
}

function onMidiOutSuccess() {
  if (midiOutPort) {
    midiOutPort.close();
  }
  midiOutPort = this;
  midiOutName = this.name();
  setListbox(selectMidiOut, midiOutName);
}

function onMidiOutFail() {
  if (midiOutPort) through.connect(midiOutPort);
  setListbox(selectMidiOut, midiOutName);
}

JZZ.synth.Tiny.register('Web Audio');

JZZ().and(function(){
  var i;
  for (i = 0; i < this.info().outputs.length; i++) {
    selectMidiOut[i] = new Option(this.info().outputs[i].name);
  }
  if (!i) {
    selectMidiOut[i] = new Option('Not available');
  }
  for (i = 0; i < this.info().inputs.length; i++) {
    openMidiIn(this.info().inputs[i].name);
  }
});

JZZ().openMidiOut().or(onMidiOutFail).and(onMidiOutSuccess);

function openMidiIn(name) {
  JZZ().openMidiIn(name).connect(function(msg) {
    print(name + ' => ' + format(msg));
  });
}

function changeMidiOut() {
  var name = selectMidiOut.options[selectMidiOut.selectedIndex].value;
  if (name == midiOutName) return;
  JZZ().openMidiOut(name).or(onMidiOutFail).and(onMidiOutSuccess);
}

function changeInput(e) {
  if (e.which == 13) {
    reportSpan.innerHTML = '';
    try {
      var msg = parse(textInput.value.trim());
      if (msg) {
        var str = format(msg);
        textInput.value = '';
        ptr = -1;
        if (!previous.length || previous[previous.length - 1] != str) previous.push(str);
        print(midiOutName + ' <= ' + str);
        if (midiOutPort) midiOutPort.send(msg);
      }
    }
    catch (s) {
      reportSpan.innerHTML = s.toString().replace(/&/, '&amp;').replace(/</, '&lt;').replace(/>/, '&gt;');
    }
  }
  else if (e.keyCode == 27) {
    ptr = -1;
    textInput.value = '';
  }
  else if (e.keyCode == 38) {
    if (previous.length) {
      if (ptr == -1) ptr = previous.length;
      if (ptr) ptr--;
      textInput.value = previous[ptr];
    }
  }
  else if (e.keyCode == 40) {
    if (previous.length && ptr != -1) {
      if (ptr < previous.length - 1) ptr++;
      textInput.value = previous[ptr];
    }
  }
}

function parse(input) {
  if (!input) return;
  var arr = input.split(/\s+/);
  if (!arr.length) return;
  var msg = [];
  for (var i = 0; i < arr.length; i++) {
    var x = parseInt(arr[i], 16);
    if (isNaN(x) || x < 0 || x > 255 || arr[i].search(/[^0-9A-Fa-f]/) != -1) {
      throw('Bad MIDI value: ' + arr[i]);
    }
    msg.push(x);
  }
  return msg;
}

function format(msg) {
  return msg.map(function(x) { return x < 16 ? '0' + x.toString(16) : x.toString(16); }).join(' ');
}

function print(str) {
  output.push(str.replace(/&/, '&amp;').replace(/</, '&lt;').replace(/>/, '&gt;'));
  while (output.length > 10) output.shift(); 
  textOutput.innerHTML = output.join('<br>');
}

selectMidiOut.addEventListener('change', changeMidiOut);
textInput.addEventListener('keydown', changeInput);

--></script>

</body>
</html>
